<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта OpenLayers з MapTiler</title>
    <!-- Підключення бібліотеки OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <!-- Підключення Font Awesome для іконок -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Запобігаємо прокрутці */
        }
        #map {
            width: 100%;
            height: 100vh; /* Карта займатиме всю висоту вікна браузера */
        }

        /* Стилі для кастомних кнопок керування картою (нижній блок) */
        .map-controls-bottom {
            position: absolute;
            bottom: 10px; /* Менший відступ для десктопа */
            right: 10px; /* Менший відступ для десктопа */
            display: flex;
            flex-direction: column;
            gap: 5px; /* Менший відступ між кнопками */
            z-index: 1000; /* Переконайтесь, що кнопки знаходяться поверх карти */
        }

        /* Стилі для кастомних елементів керування картою (верхній правий блок) */
        .map-controls-top-right {
            position: absolute;
            top: 80px; /* Змінено з 10px на 80px (10 + 70) */
            right: 10px; /* Менший відступ для десктопа */
            display: flex;
            flex-direction: column;
            gap: 5px; /* Менший відступ між кнопками */
            z-index: 1000; /* Переконайтесь, що елементи знаходяться поверх карти */
            align-items: center; /* Центруємо елементи всередині */
        }

        /* Стилі для кастомних елементів керування картою (верхній лівий блок) */
        .map-controls-top-left {
            position: absolute;
            top: 80px; /* Змінено з 10px на 80px (10 + 70) */
            left: 10px; /* Менший відступ для десктопа */
            display: flex;
            flex-direction: column;
            gap: 5px; /* Менший відступ між кнопками */
            z-index: 1000;
            align-items: center;
        }

        .map-button {
            width: 35px; /* Менший розмір для десктопа */
            height: 35px; /* Менший розмір для десктопа */
            border-radius: 50%; /* Кругла форма */
            background-color: rgba(224, 224, 224, 0.5); /* Світло-сірий прозорий колір */
            backdrop-filter: blur(5px); /* Ефект розмиття */
            color: #333; /* Темніший колір тексту/іконки для контрасту */
            border: none;
            cursor: pointer;
            font-size: 1em; /* Менший розмір шрифту */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: none; /* Прибрано тінь */
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .map-button:hover {
            background-color: rgba(192, 192, 192, 0.7); /* Трохи темніший сірий при наведенні */
            transform: scale(1.05);
        }

        .map-button:active {
            transform: scale(0.95);
        }

        .map-button i {
            font-size: 1em; /* Менший розмір іконки */
        }

        /* Стилі для круглого регулятора повороту */
        .rotation-dial-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .rotation-dial {
            width: 35px; /* Менший розмір для десктопа */
            height: 35px; /* Менший розмір для десктопа */
            border-radius: 50%; /* Кругла форма */
            background-color: rgba(224, 224, 224, 0.5); /* Світло-сірий прозорий колір */
            backdrop-filter: blur(5px); /* Ефект розмиття */
            border: none; /* Прибрано обводку */
            box-shadow: none; /* Прибрано тінь */
            position: relative;
            cursor: grab; /* Курсор при наведенні */
            transition: transform 0.05s linear; /* Плавний поворот */
        }

        .rotation-dial:active {
            cursor: grabbing; /* Курсор під час перетягування */
        }

        .north-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333; /* Колір стрілки як на кнопках */
            pointer-events: none; /* Щоб не перехоплював події миші */
        }

        .north-indicator i {
            font-size: 1.4em; /* Менший розмір іконки */
            text-shadow: none; /* Прибрано тінь */
            transform: rotate(-45deg); /* Компенсація для fa-location-arrow, щоб вона вказувала прямо вгору */
        }

        /* Приховано відображення значення повороту */
        .rotation-value-display {
            display: none;
        }

        /* Стилі для нової кнопки "Північ" */
        #northButton {
            width: 7px; /* Менший розмір для десктопа */
            height: 12px; /* Менший розмір для десктопа */
            border-radius: 50%;
            background-color: #333; /* Суцільний колір */
            color: white; /* Колір для фону, якщо немає іконки */
            border: none;
            cursor: pointer;
            font-size: 0; /* Приховуємо будь-який текст */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: none;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #northButton:hover {
            background-color: rgba(0, 0, 0, 0.8);
            transform: scale(1.05);
        }

        /* Стилі для іконки будинку SVG */
        .icons8-home {
            display: inline-block;
            width: 20px; /* Менший розмір іконки */
            height: 20px; /* Менший розмір іконки */
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciICB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNHB4IiBoZWlnaHQ9IjI0cHgiPjxwYXRoIGQ9Ik0gMTIgMi4wOTk2MDk0IEwgMSAxMiBMIDQgMTIgTCA0IDIxIEwgMTEgMjEgTCAxMSAxNSBMIDEzIDE1IEwgMTMgMjEgTCAyMCAyMSBMIDIwIDEyIEwgMjMgMTIgTCAxMiAyLjA5OTYwOTQgeiBNIDEyIDQuNzkxMDE1NiBMIDE4IDEwLjE5MTQwNiBMIDE4IDExIEwgMTggMTkgTCAxNSAxOSBMIDE1IDEzIEwgOSAxMyBMIDkgMTkgTCA2IDE5IEwgNiAxMC4xOTE0MDYgTCAxMiA0Ljc5MTAxNTYgeiIvPjwvc3ZnPg==') 50% 50% no-repeat;
            background-size: 100%;
        }

        /* Стилі для елемента керування атрибуцією OpenLayers */
        .ol-attribution {
            left: 10px !important; /* Переміщуємо вліво */
            right: auto !important; /* Вимикаємо позиціонування праворуч */
            bottom: 10px !important; /* Залишаємо внизу */
            background-color: rgba(224, 224, 224, 0.5); /* Прозорий білий фон */
            backdrop-filter: blur(5px); /* Ефект розмиття */
            border-radius: 5px; /* Закруглені кути */
            padding: 2px 5px; /* Невеликий відступ */
            box-shadow: none; /* Прибираємо тінь */
            z-index: 1000; /* Переконаємось, що знаходиться поверх карти */
        }

        /* Стилі для бічної панелі (спливаючого вікна) */
        .side-panel {
            position: absolute;
            top: 80px; /* Змінено з 10px на 80px */
            left: -320px; /* Початково приховано */
            width: 300px; /* Ширина панелі */
            height: calc(100vh - 160px); /* Висота з урахуванням відступів (80px + 80px) */
            background-color: rgba(255, 255, 255, 0.9); /* Напівпрозорий білий фон */
            backdrop-filter: blur(10px); /* Ефект розмиття */
            z-index: 2000; /* Вище, ніж кнопки карти */
            transition: left 0.3s ease-out; /* Плавна анімація появи/зникнення */
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2); /* Тінь для візуального відділення */
            display: flex;
            flex-direction: column;
            border-radius: 20px; /* Округлення всіх кутів для ефекту "бульбашки" */
            overflow: hidden; /* Обрізаємо вміст, щоб він не виходив за заокруглені кути */
        }

        .side-panel.open {
            left: 10px; /* Висуваємо панель на екран з відступом */
        }

        .side-panel-close-button {
            position: absolute; /* Розміщуємо кнопку поверх усього */
            top: 10px;
            right: 10px;
            background: rgba(224, 224, 224, 0.5); /* Фон як у кнопок */
            backdrop-filter: blur(5px); /* Розмиття як у кнопок */
            border: none;
            font-size: 1.2em; /* Менший розмір шрифту */
            cursor: pointer;
            color: #333;
            z-index: 2001; /* Вище, ніж iframe */
            border-radius: 50%; /* Кругла форма */
            width: 25px; /* Менший розмір кнопки */
            height: 25px; /* Менший розмір кнопки */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: none;
            transition: background-color 0.3s ease; /* Прибрано transform з transition */
        }

        .side-panel-close-button:hover {
            background-color: rgba(192, 192, 192, 0.7);
        }

        .side-panel-iframe {
            flex-grow: 1; /* Займає весь доступний простір */
            width: 100%;
            height: 100%; /* Iframe займає 100% висоти батьківського елемента */
            border: none;
            border-radius: 20px; /* Заокруглення всіх кутів iframe */
        }

        /* Мобільні стилі: більші кнопки та відступи */
        @media (pointer: coarse) and (max-width: 768px) {
            .map-controls-bottom {
                bottom: 40px;
                right: 20px;
                gap: 10px;
            }

            .map-controls-top-right {
                top: 160px; /* Змінено з 90px на 160px (90 + 70) */
                right: 20px;
                gap: 10px;
            }

            .map-controls-top-left {
                top: 160px; /* Змінено з 90px на 160px (90 + 70) */
                left: 20px;
                gap: 10px;
            }

            .map-button {
                width: 45px; /* Більший розмір */
                height: 45px; /* Більший розмір */
                font-size: 1.2em; /* Більший розмір шрифту */
            }

            .map-button i {
                font-size: 1.2em; /* Більший розмір іконки */
            }

            .rotation-dial {
                width: 45px; /* Більший розмір */
                height: 45px; /* Більший розмір */
            }

            #northButton {
                width: 9px; /* Більший розмір */
                height: 12px; /* Більший розмір */
            }

            .north-indicator i {
                font-size: 1.8em; /* Більший розмір іконки */
            }

            .icons8-home {
                width: 24px; /* Більший розмір іконки */
                height: 24px; /* Більший розмір іконки */
            }

            .side-panel {
                top: 160px; /* Змінено з 90px на 160px */
                left: -320px; /* Ширина + лівий відступ */
                height: calc(100vh - 320px); /* Висота з урахуванням відступів (160px + 160px) */
            }

            .side-panel.open {
                left: 20px; /* Відступ при відкритті */
            }

            .side-panel-close-button {
                width: 30px; /* Більший розмір кнопки */
                height: 30px; /* Більший розмір кнопки */
                font-size: 1.5em; /* Більший розмір шрифту */
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="map-controls-bottom">
        <button id="homeButton" class="map-button" title="Повернутись до початкової позиції">
            <div class="icons8-home"></div> <!-- Нова SVG іконка будинку -->
        </button>
        <button id="zoomInButton" class="map-button" title="Збільшити">
            <i class="fas fa-plus"></i>
        </button>
        <button id="zoomOutButton" class="map-button" title="Зменшити">
            <i class="fas fa-minus"></i>
        </button>
    </div>

    <div class="map-controls-top-right">
        <button id="northButton" title="Встановити північ"></button> <!-- Кнопка без іконки -->
        <div class="rotation-dial-container">
            <div id="rotationDial" class="rotation-dial">
                <div id="northIndicator" class="north-indicator">
                    <i class="fas fa-location-arrow"></i> <!-- Іконка стрілки для навігатора -->
                </div>
            </div>
            <!-- Приховано відображення значення повороту -->
            <div class="rotation-value-display">
                Поворот: <span id="rotationValue">0</span>°
            </div>
        </div>
    </div>

    <div class="map-controls-top-left">
        <button id="openPanelButton" class="map-button" title="Відкрити бічну панель">
            <img src="https://img.icons8.com/material-rounded/48/list.png" alt="List Icon" style="width: 24px; height: 24px;">
        </button>
    </div>

    <!-- Бічна панель -->
    <div id="sidePanel" class="side-panel">
        <button id="closePanelButton" class="side-panel-close-button">
            <i class="fas fa-times"></i>
        </button>
        <iframe id="panelIframe" class="side-panel-iframe" src="https://www.google.com"></iframe>
    </div>

    <!-- Підключення бібліотеки OpenLayers JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <!-- Підключення бібліотеки ol-mapbox-style для завантаження стилів MapTiler -->
    <script src="https://cdn.jsdelivr.net/npm/ol-mapbox-style@12.0.0/dist/olms.js"></script>
    <script>
        // Ваш MapTiler API-ключ
        const mapTilerApiKey = '7JUTiyTWHkC7qe7Dy8Qj';
        // URL стилю MapTiler (style.json)
        const mapTilerStyleUrl = `https://api.maptiler.com/maps/01980891-51b4-7eed-89ae-ee81612e0ea5/style.json?key=${mapTilerApiKey}`;
        // URL додаткового шару MapTiler
        const customLayerUrl = `https://api.maptiler.com/tiles/01980822-6890-7fcf-8ee2-6aba7cca6ae7/{z}/{x}/{y}.webp?key=${mapTilerApiKey}`;

        // Початкові параметри вигляду карти для кнопки "Додому"
        const initialCenter = ol.proj.fromLonLat([32.052061716737846, 49.43710241800906]);
        const initialZoom = 17; // Зум 17
        const initialMapRotationDegrees = -40; // 40 градусів проти годинникової стрілки
        const initialMapRotationRadians = initialMapRotationDegrees * Math.PI / 180;

        // Ініціалізація карти OpenLayers без початкових шарів, оскільки olms.apply додасть їх
        const map = new ol.Map({
            target: 'map', // Елемент HTML, в якому буде відображатися карта
            // Вимикаємо стандартні елементи керування OpenLayers, окрім атрибуції
            controls: ol.control.defaults.defaults({
                zoom: false, // Вимикаємо стандартні кнопки масштабування
                rotate: false, // Вимикаємо стандартну кнопку повороту
                attribution: true // Залишаємо стандартну кнопку атрибуції
            }),
            view: new ol.View({
                center: initialCenter,
                zoom: initialZoom,
                rotation: initialMapRotationRadians
            })
        });

        // Застосування стилю MapTiler до карти за допомогою ol-mapbox-style
        olms.apply(map, mapTilerStyleUrl).then(function (map) {
            // Після того, як базовий стиль застосовано, додаємо додатковий шар
            map.addLayer(new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: customLayerUrl,
                    attributions: 'Map data &copy; <a href="https://www.maptiler.com/copyright/" target="_blank">MapTiler</a>'
                })
            }));
        }).catch(function(error) {
            console.error("Помилка при завантаженні стилю MapTiler:", error);
            // Можна додати повідомлення для користувача, якщо карта не завантажилася
            document.getElementById('map').innerText = 'Не вдалося завантажити карту. Перевірте консоль для деталей.';
        });

        // Отримання посилань на кнопки та регулятор повороту
        const zoomInButton = document.getElementById('zoomInButton');
        const zoomOutButton = document.getElementById('zoomOutButton');
        const homeButton = document.getElementById('homeButton');
        const rotationDial = document.getElementById('rotationDial');
        const northButton = document.getElementById('northButton'); // Нова кнопка "Північ"
        const openPanelButton = document.getElementById('openPanelButton'); // Нова кнопка відкриття панелі
        const sidePanel = document.getElementById('sidePanel'); // Бічна панель
        const closePanelButton = document.getElementById('closePanelButton'); // Кнопка закриття панелі

        let isDraggingDial = false;
        let dialCenterX, dialCenterY;
        let startMouseAngle; // Кут миші відносно центру регулятора при натисканні
        let initialMapRotationOnDragStart; // Початковий поворот карти при початку перетягування

        // Функція для оновлення візуального стану регулятора
        function updateRotationDial(mapRotationRadians) {
            // Візуальний поворот регулятора має бути протилежним повороту карти,
            // щоб стрілка завжди вказувала на географічну північ
            let dialVisualRotationRadians = -mapRotationRadians;
            rotationDial.style.transform = `rotate(${dialVisualRotationRadians * 180 / Math.PI}deg)`;
        }

        // Встановлення початкового стану регулятора
        updateRotationDial(initialMapRotationRadians);

        // Обробники подій для регулятора повороту
        rotationDial.addEventListener('mousedown', function(e) {
            isDraggingDial = true;
            rotationDial.style.cursor = 'grabbing';
            const rect = rotationDial.getBoundingClientRect();
            dialCenterX = rect.left + rect.width / 2;
            dialCenterY = rect.top + rect.height / 2;

            // Зберігаємо початковий кут миші та початковий поворот карти
            startMouseAngle = Math.atan2(e.clientY - dialCenterY, e.clientX - dialCenterX);
            initialMapRotationOnDragStart = map.getView().getRotation();

            e.preventDefault(); // Запобігаємо виділенню тексту
        });

        // Прив'язуємо mousemove та mouseup до document для глобального відстеження
        document.addEventListener('mousemove', function(e) {
            if (!isDraggingDial) return;

            const currentMouseX = e.clientX - dialCenterX;
            const currentMouseY = e.clientY - dialCenterY;

            // Поточний кут миші відносно центру регулятора
            let currentMouseAngle = Math.atan2(currentMouseY, currentMouseX);

            // Розраховуємо зміну кута
            let angleDelta = currentMouseAngle - startMouseAngle;

            // Новий поворот карти = початковий поворот + зміна кута миші
            // Для того, щоб обертання карти відповідало напрямку руху миші,
            // коли миша рухається за годинниковою стрілкою (angleDelta стає від'ємним),
            // поворот карти має збільшуватися (ставати більш позитивним).
            // Отже, ми віднімаємо angleDelta.
            let newMapRotationRadians = initialMapRotationOnDragStart - angleDelta;

            map.getView().setRotation(newMapRotationRadians);

            // Оновлюємо візуальне відображення регулятора
            updateRotationDial(newMapRotationRadians);
        });

        document.addEventListener('mouseup', function() {
            if (isDraggingDial) {
                isDraggingDial = false;
                rotationDial.style.cursor = 'grab';
            }
        });

        // Додаємо обробник події mouseleave до вікна, щоб зупинити обертання, якщо миша виходить за межі фрейма
        window.addEventListener('mouseleave', function() {
            if (isDraggingDial) {
                isDraggingDial = false;
                rotationDial.style.cursor = 'grab';
            }
        });

        // Обробник зміни повороту карти (наприклад, якщо користувач перетягує карту)
        map.getView().on('change:rotation', function() {
            updateRotationDial(map.getView().getRotation());
        });

        // Додавання обробників подій для кнопок
        zoomInButton.addEventListener('click', function() {
            const view = map.getView();
            const currentZoom = view.getZoom();
            view.setZoom(currentZoom + 1);
        });

        zoomOutButton.addEventListener('click', function() {
            const view = map.getView();
            const currentZoom = view.getZoom();
            view.setZoom(currentZoom - 1);
        });

        homeButton.addEventListener('click', function() {
            const view = map.getView();
            view.setCenter(initialCenter);
            view.setZoom(initialZoom);
            view.setRotation(initialMapRotationRadians); // Встановлюємо початковий поворот карти
            // Оновлюємо регулятор та його відображення до початкового стану
            updateRotationDial(initialMapRotationRadians);
        });

        // Обробник для нової кнопки "Північ"
        northButton.addEventListener('click', function() {
            const view = map.getView();
            view.setRotation(0); // Встановлюємо поворот на 0 радіан (географічна північ)
            updateRotationDial(0); // Оновлюємо регулятор
        });

        // Обробники для бічної панелі
        openPanelButton.addEventListener('click', function() {
            sidePanel.classList.add('open');
        });

        closePanelButton.addEventListener('click', function() {
            sidePanel.classList.remove('open');
        });
    </script>
</body>
</html>
