<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Класифікація будівель — динамічні дані з JSON</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --brand:#2563eb; --brand-2:#1e40af; --bg:#f7f8fa; --ink:#1f2937; --line:#e5e7eb; }
  *{box-sizing:border-box}
  body{font-family:'Montserrat',sans-serif;background:var(--bg);color:var(--ink);margin:0;display:flex}
  nav{width:280px;background:#fff;border-right:1px solid var(--line);height:100vh;position:sticky;top:0;overflow:auto;padding:1rem;transition:width .25s ease,padding .25s ease}
  body.nav-collapsed nav{width:0;padding:0;border:none;overflow:hidden}
  nav h2{font-size:1.05rem;margin:0 0 .75rem 0}
  nav ul{list-style:none;padding-left:0;margin:0}
  nav li{margin:4px 0;position:relative}
  nav a{display:block;text-decoration:none;color:var(--brand);font-weight:600;padding:6px 10px;border-radius:8px}
  nav a:hover{background:#eff6ff}
  nav li.level-1 a{padding-left:6px}
  nav li.level-2 a{padding-left:20px;font-weight:600;font-size:.95em}
  nav li.level-3 a{padding-left:34px;font-weight:500;font-size:.9em}
  nav li.level-4 a{padding-left:48px;font-weight:500;font-size:.85em}

  .wrap{flex:1;max-width:1100px;margin:0 auto;padding:20px;position:relative}
  header{display:flex;gap:10px;align-items:center;background:#fff;padding:12px 20px;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:20}
  #toggleNav{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer;font-size:1rem;font-weight:600;transition:background .2s}
  #toggleNav:hover{background:#f3f4f6}
  header h1{flex:0 0 auto;margin:0;font-size:1.4rem}
  header input{flex:1 1 auto;padding:8px 12px;border:1px solid var(--line);border-radius:8px;font-size:1rem}

  h1{font-weight:700}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:top;transition:background .15s}
  thead th{background:#f3f4f6;position:sticky;top:60px;z-index:10}
  tr:hover td{background:#f8fafc}
  .group-title{background:#e0f2fe;font-weight:700;position:sticky;top:calc(60px + 0rem);z-index:6}
  .subgroup-title{background:#fef9c3;font-weight:600;position:sticky;top:calc(60px + 2rem);z-index:5}
  .code{text-align:center;font-weight:700;white-space:nowrap}
  a.code-link{color:var(--brand);text-decoration:underline;cursor:pointer}
  a.code-link:hover{color:#1d4ed8}
  .desc{font-size:.95em;color:#374151}
  .desc ul{margin:.35rem 0 .6rem 1.05rem}
  .desc li{margin:.15rem 0}
  .meta{display:block;margin-top:.25rem;font-size:.85em;color:#374151}
  .meta b{color:#111827}
  .muted{color:#6b7280}

  #toast{position:fixed;bottom:50px;left:50%;transform:translateX(-50%);background:var(--brand-2);color:#fff;padding:10px 20px;border-radius:10px;font-size:.92rem;opacity:0;transition:opacity .25s;pointer-events:none}
  #toast.show{opacity:1}
</style>
</head>
<body>
  <nav aria-label="Навігація по кодах">
    <h2>Навігація</h2>
    <ul id="nav-list"></ul>
  </nav>
  <div class="wrap">
    <header>
      <button id="toggleNav" aria-expanded="true" aria-controls="nav-list">◀</button>
      <h1>Класифікація будівель</h1>
      <input id="search" type="search" placeholder="Пошук за назвою або кодом…" aria-label="Пошук">
    </header>
    <div class="muted" id="status">Завантаження даних…</div>
    <table id="classification" aria-live="polite">
      <thead>
        <tr>
          <th colspan="4">Код</th>
          <th>Назва класифікаційної одиниці</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>
  <div id="toast" role="status" aria-live="polite">Скопійовано</div>

<script>
(async function(){
  const tbody=document.getElementById('table-body');
  const navList=document.getElementById('nav-list');
  const search=document.getElementById('search');
  const status=document.getElementById('status');
  const theadEl=document.querySelector('thead');
  const headerEl=document.querySelector('header');
  const toast=document.getElementById('toast');
  const toggleNavBtn=document.getElementById('toggleNav');

  const JSON_URL='https://wgis.project.co.ua/building_classification_full.json';

  function setNavCollapsed(collapsed){
    document.body.classList.toggle('nav-collapsed',collapsed);
    toggleNavBtn.textContent=collapsed?'▶':'◀';
    toggleNavBtn.setAttribute('aria-expanded', String(!collapsed));
    try{localStorage.setItem('navCollapsed', collapsed?'1':'0');}catch{}
  }
  function getStoredCollapse(){
    try{return localStorage.getItem('navCollapsed')==='1';}catch{return false}
  }
  setNavCollapsed(getStoredCollapse());
  toggleNavBtn.addEventListener('click',()=>{
    const collapsed=document.body.classList.contains('nav-collapsed');
    setNavCollapsed(!collapsed);
  });

  function getOffsetForTarget(){
    const headerH=headerEl?.offsetHeight||0;
    const theadH=theadEl?.getBoundingClientRect().height||0;
    return headerH+theadH+20;
  }
  function smartScrollToId(id){
    const target=document.getElementById(id);
    if(!target)return;
    const offset=getOffsetForTarget();
    const top=target.getBoundingClientRect().top+window.scrollY-offset;
    window.scrollTo({top,behavior:'smooth'});
  }

  try{
    const res=await fetch(JSON_URL,{mode:'cors',cache:'no-cache'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const raw=await res.json();

    const rows=[];
    function traverse(node,level=1){
      if(!node)return;
      Object.entries(node).forEach(([code,obj])=>{
        if(obj&&typeof obj==='object'&&obj.name){
          rows.push({id:String(code),level,name:obj.name,includes:obj.includes||[],excludes:obj.excludes||[],note:obj.note||''});
        }
        if(obj.groups)traverse(obj.groups,level+1);
        if(obj.classes)traverse(obj.classes,level+1);
        if(obj.subclasses)traverse(obj.subclasses,level+1);
      });
    }
    traverse(raw);

    const codeToLevel=code=>String(code).length;
    const makeCodeCells=(code,lvl)=>Array(4).fill('').map((_,i)=>{
      if(i===lvl-1){
        if(lvl>=4){
          return `<td class='code'><a class='code-link' data-code='${code}' title='Скопіювати код у буфер'>${code}</a></td>`;
        }
        return `<td class='code'>${code}</td>`;
      }
      return '<td></td>';
    }).join('');

    const linkifyRefs=text=>text?text.replace(/\b(\d{1,4})\b/g,(m,code)=>`<a href='#sec-${code}'>${code}</a>`):'';
    const renderLists=(label,items)=>!items||!items.length?'':`<div class='desc'><b>${label}:</b><ul>${items.map(x=>`<li>${linkifyRefs(String(x))}</li>`).join('')}</ul></div>`;

    rows.sort((a,b)=>a.id.localeCompare(b.id,'uk'));

    for(const r of rows){
      const tr=document.createElement('tr');
      const lvl=r.level||codeToLevel(r.id);
      tr.id=`sec-${r.id}`;
      if(lvl===1)tr.classList.add('group-title');
      if(lvl===2)tr.classList.add('subgroup-title');
      const codeCells=makeCodeCells(r.id,lvl);
      const noteBlock=r.note?`<div class='desc'>${linkifyRefs(String(r.note))}</div>`:'';
      const includes=renderLists('Цей клас включає',r.includes);
      const excludes=renderLists('Цей клас не включає',r.excludes);
      const meta=(includes||excludes||noteBlock)?`<span class='meta'><b>Деталі:</b></span>${noteBlock}${includes}${excludes}`:'';
      tr.innerHTML=`${codeCells}<td><strong>${r.name||''}</strong>${meta}</td>`;
      tbody.appendChild(tr);
    }

    rows.forEach(r=>{
      const li=document.createElement('li');
      li.classList.add(`level-${Math.min(r.level,4)}`);
      const a=document.createElement('a');
      a.href=`#sec-${r.id}`;
      a.textContent=`${r.id} — ${r.name}`;
      li.dataset.target=`sec-${r.id}`;
      li.appendChild(a);
      navList.appendChild(li);
    });

    document.addEventListener('click',e=>{
      const codeA=e.target.closest('.code-link');
      if(codeA){
        navigator.clipboard.writeText(codeA.dataset.code).then(()=>{
          toast.textContent='Скопійовано: '+codeA.dataset.code;
          toast.classList.add('show');
          setTimeout(()=>toast.classList.remove('show'),1000);
        });
        return;
      }
    });

    navList.addEventListener('click',e=>{
      const a=e.target.closest('a');
      if(!a)return;
      e.preventDefault();
      const id=a.getAttribute('href').slice(1);
      smartScrollToId(id);
      history.pushState(null,'','#'+id);
    });
    document.addEventListener('click',e=>{
      const a=e.target.closest('a[href^="#sec-"]');
      if(!a)return;
      e.preventDefault();
      const id=a.getAttribute('href').slice(1);
      smartScrollToId(id);
      history.pushState(null,'','#'+id);
    });
    window.addEventListener('popstate',()=>{
      if(location.hash){
        const id=location.hash.substring(1);
        const el=document.getElementById(id);
        if(el)setTimeout(()=>smartScrollToId(id),0);
      }
    });

    search.addEventListener('input',()=>{
      const q=search.value.toLowerCase().trim();
      const visibleIds=new Set();
      for(const tr of tbody.querySelectorAll('tr')){
        const text=tr.textContent.toLowerCase();
        const show=(q===''||text.includes(q));
        tr.style.display=show?'':'none';
        if(show)visibleIds.add(tr.id);
      }
      for(const li of navList.querySelectorAll('li')){
        const targetId=li.dataset.target;
        li.style.display=visibleIds.has(targetId)?'':'none';
      }
    });

    status.textContent='Дані завантажено';
  }catch(err){
    status.textContent='Не вдалося завантажити дані: '+err;
    console.error(err);
  }
})();
</script>
</body>
</html>
