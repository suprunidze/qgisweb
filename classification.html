<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Класифікація будівель — динамічні дані з JSON</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#2563eb; --brand-2:#1e40af; --bg:#f7f8fa; --ink:#1f2937; --line:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{font-family:'Montserrat',sans-serif;background:var(--bg);color:var(--ink);margin:0;display:flex}
  nav{width:280px;background:#fff;border-right:1px solid var(--line);height:100vh;position:sticky;top:0;overflow-y:auto;padding:1rem}
  nav h2{font-size:1.05rem;margin:0 0 .75rem 0}
  nav ul{list-style:none;padding-left:0;margin:0}
  nav li{margin:4px 0;position:relative}
  nav a{display:block;text-decoration:none;color:var(--brand);font-weight:600;padding:6px 10px;border-radius:8px}
  nav a:hover{background:#eff6ff}
  nav a.active{background:#dbeafe;color:var(--brand-2)}
  nav li.level-1 a{padding-left:6px}
  nav li.level-2 a{padding-left:18px;font-weight:600;font-size:.95em}
  nav li.level-3 a{padding-left:30px;font-weight:500;font-size:.9em}
  .active-indicator{position:absolute;left:-6px;top:9px;width:4px;height:70%;background:var(--brand);border-radius:2px;opacity:0;transition:opacity .2s}
  nav a.active+._ind{opacity:1}

  .wrap{flex:1;max-width:1100px;margin:0 auto;padding:20px;position:relative}
  h1{font-weight:700;font-size:1.8rem;margin:.2rem 0 1rem}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:top;transition:background .15s}
  thead th{background:#f3f4f6;position:sticky;top:0;z-index:10}
  tr:hover td{background:#f8fafc}
  .group-title{background:#e0f2fe;font-weight:700;position:sticky;top:2.6rem;z-index:6}
  .subgroup-title{background:#fef9c3;font-weight:600;position:sticky;top:calc(2.6rem + 1.9em);z-index:5}
  .code{text-align:center;font-weight:700;white-space:nowrap}
  a.code-link{color:var(--brand);text-decoration:underline;cursor:pointer}
  a.code-link:hover{color:#1d4ed8}
  .desc{font-size:.95em;color:#374151}
  .desc ul{margin:.35rem 0 .6rem 1.05rem}
  .desc li{margin:.15rem 0}
  .meta{display:block;margin-top:.25rem;font-size:.85em;color:#374151}
  .meta b{color:#111827}
  #toast{position:fixed;bottom:50px;left:50%;transform:translateX(-50%);background:var(--brand-2);color:#fff;padding:10px 20px;border-radius:10px;font-size:.92rem;opacity:0;transition:opacity .35s;pointer-events:none}
  #toast.show{opacity:1}
  #scrollTopBtn{position:fixed;bottom:24px;right:24px;background:var(--brand);color:#fff;border:none;border-radius:50%;width:48px;height:48px;font-size:22px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.2);opacity:0;visibility:hidden;transition:opacity .25s}
  #scrollTopBtn.show{opacity:1;visibility:visible}
  .muted{color:#6b7280}
</style>
</head>
<body>
  <nav>
    <h2>Навігація</h2>
    <ul id="nav-list"></ul>
  </nav>
  <div class="wrap">
    <h1>Класифікація будівель і споруд</h1>
    <div class="muted" id="status">Завантаження даних…</div>
    <table id="classification" aria-live="polite">
      <thead>
        <tr>
          <th colspan="4">Код</th>
          <th>Назва класифікаційної одиниці</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>
  <div id="toast">Скопійовано</div>
  <button id="scrollTopBtn" title="Наверх">↑</button>

<script>
(async function(){
  const tbody=document.getElementById('table-body');
  const navList=document.getElementById('nav-list');
  const status=document.getElementById('status');
  const toast=document.getElementById('toast');
  const scrollTopBtn=document.getElementById('scrollTopBtn');

  const JSON_URL='https://storage.googleapis.com/ck_blackout_pdf/building_classification_full.json';
  let raw;
  try{
    const res=await fetch(JSON_URL,{cache:'no-cache'});
    if(!res.ok)throw new Error('HTTP '+res.status);
    raw=await res.json();
    status.textContent='Дані завантажено';
  }catch(err){
    status.textContent='Не вдалося завантажити '+JSON_URL;
    console.error(err);
    return;
  }

  const rows=[];
  const pushRow=(code,node,level)=>{
    rows.push({
      id:String(code),
      level:level,
      name:node.name||node.title||'',
      includes:node.includes||node.include||[],
      excludes:node.excludes||node.exclude||[],
      seeAlso:node.ref||node.refs||node.related||[],
      note:node.note||node.desc||node.description||''
    });
  };

  const isPlainArray=Array.isArray(raw);
  if(isPlainArray){raw.forEach(it=>{const code=it.code||it.id;if(!code)return;pushRow(code,it,it.level||(String(code).length));if(it.children){const walk=(kids,lvl)=>{Object.entries(kids).forEach(([k,v])=>{pushRow(k,v,lvl);if(v.children)walk(v.children,lvl+1);});};walk(it.children,(it.level||String(code).length)+1);}});}else if(typeof raw==='object'){const walk=(dict,lvl=1)=>{Object.entries(dict).forEach(([code,node])=>{pushRow(code,node,lvl);if(node.children)walk(node.children,lvl+1);});};walk(raw,1);}

  rows.forEach(r=>{if(typeof r.includes==='string')r.includes=r.includes.split('\n').filter(Boolean);if(typeof r.excludes==='string')r.excludes=r.excludes.split('\n').filter(Boolean);if(typeof r.seeAlso==='string')r.seeAlso=r.seeAlso.split(/[,;\s]+/).filter(Boolean);});

  const codeToLevel=code=>String(code).length;
  const makeCodeCells=(code,lvl)=>Array(4).fill('').map((_,i)=>i===lvl-1?`<td class='code'>${lvl===4?`<a class='code-link' data-code='${code}'>${code}</a>`:code}</td>`:'<td></td>').join('');
  const linkifyRefs=text=>text?text.replace(/\b(\d{1,4})\b/g,(m,code)=>`<a href='#sec-${code}'>${code}</a>`):'';
  const renderLists=(label,items)=>!items||!items.length?'':`<div class='desc'><b>${label}:</b><ul>${items.map(x=>`<li>${linkifyRefs(String(x))}</li>`).join('')}</ul></div>`;
  rows.sort((a,b)=>a.id.localeCompare(b.id,'uk'));

  for(const r of rows){const tr=document.createElement('tr');const lvl=r.level||codeToLevel(r.id);tr.id=`sec-${r.id}`;if(lvl===1)tr.classList.add('group-title');if(lvl===2)tr.classList.add('subgroup-title');const codeCells=makeCodeCells(r.id,lvl);const noteBlock=r.note?`<div class='desc'>${linkifyRefs(String(r.note))}</div>`:'';const includes=renderLists('Цей клас включає',r.includes);const excludes=renderLists('Цей клас не включає',r.excludes);const seeAlso=renderLists('Див. також',r.seeAlso||[]);const meta=(includes||excludes||seeAlso||noteBlock)?`<span class='meta'><b>Деталі:</b></span>${noteBlock}${includes}${excludes}${seeAlso}`:'';tr.innerHTML=`${codeCells}<td><strong>${r.name||''}</strong>${meta}</td>`;tbody.appendChild(tr);}  

  const uniqBy=(arr,key)=>Array.from(new Map(arr.map(o=>[key(o),o])).values());
  const navItems=uniqBy(rows.filter(r=>r.id.length<=3),r=>r.id).sort((a,b)=>a.id.localeCompare(b.id,'uk'));
  navItems.forEach(r=>{const li=document.createElement('li');const lvl=r.level||codeToLevel(r.id);li.classList.add(`level-${Math.min(lvl,3)}`);const a=document.createElement('a');a.href=`#sec-${r.id}`;a.textContent=`${r.id} — ${r.name}`;li.appendChild(a);const ind=document.createElement('div');ind.className='_ind';li.appendChild(ind);navList.appendChild(li);});

  document.addEventListener('click',e=>{const link=e.target.closest('.code-link');if(link){navigator.clipboard.writeText(link.dataset.code).then(()=>{toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1200);});}});

  const sections=Array.from(document.querySelectorAll('tbody tr[id]'));
  const navLinks=Array.from(document.querySelectorAll('nav a'));
  function stickyBottom(){let h=0;document.querySelectorAll('thead th,.group-title,.subgroup-title').forEach(el=>{const r=el.getBoundingClientRect();if(r.bottom>h&&r.top<=0)h=r.bottom;});return h;}
  function highlightByTopVisible(){const cutoff=stickyBottom()+6;let topSec=null;for(const sec of sections){const r=sec.getBoundingClientRect();if(r.top>cutoff){topSec=sec;break;}}if(topSec){const id=topSec.id;navLinks.forEach(a=>a.classList.remove('active'));const link=document.querySelector(`nav a[href='#${id}']`);if(link)link.classList.add('active');}}
  window.addEventListener('scroll',()=>{highlightByTopVisible();if(window.scrollY>400)scrollTopBtn.classList.add('show');else scrollTopBtn.classList.remove('show');},{passive:true});window.addEventListener('resize',highlightByTopVisible);highlightByTopVisible();
  navList.addEventListener('click',e=>{const a=e.target.closest('a');if(!a)return;e.preventDefault();const id=a.getAttribute('href').slice(1);const target=document.getElementById(id);if(!target)return;const rect=target.getBoundingClientRect();const offset=stickyBottom();window.scrollTo({top:window.scrollY+rect.top-offset-8,behavior:'smooth'});});
  scrollTopBtn.addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'}));
})();
</script>
</body>
</html>